# 8. HTTP 헤더 2 - 캐시와 조건부 요청

## 캐시 기본 동작

---

### 캐시가 없을 때

데이터가 변경되지 않아도 계속 네트워크를 통해서 데이터를 다운받아야 한다.

### 캐시 적용

캐시를 통해 캐시 가능 시간 동안 네트워크를 사용하지 않아도 된다.

### 캐시 시간 초과

캐시 유효 시간이 초과되면, 서버를 통해 데이터를 다시 조회하고, 캐시를 갱신한다.

## 검증 헤더와 조건부 요청 1

---

### 검증 헤더

캐시 데이터와 서버 데이터가 같은지 검증하는 데이터

> **Last-Modified: 2020년 11월 10일 10:00:00**
> 

### 조건부 요청

검증 헤더로 조건에 따른 분기

> **if-modified-since: 2020년 11월 10일 10:00:00**
> 

### 캐시 시간 초과

캐시가 만료된 후에도 서버에서 데이터를 변경하지 않았을 경우, 클라이언트와 서버의 데이터가 같다는 사실을 확인할 수 있다면 저장해두었던 캐시를 재사용 할 수 있다.

1. 캐시 유효 시간이 초과해도, 서버의 데이터가 갱신되지 않으면 304 Not Modified 와 바디 없이 헤더의 메타 정보만 응답한다.
2. 클라이언트는 서버가 보낸 응답 헤더 정보를 통해 캐시의 메타 정보를 갱신하고 캐시에 저장되어 있는 데이터를 재활용한다.
3. 결과적으로 네트워크 다운로드가 발생하지만 용량이 적은 헤더 정보만 다운로드 받을 수 있다.

## 검증 헤더와 조건부 요청 2

---

### Last-Modified 와 If-Modified-Since 의 단점

- 날짜 기반의 로직을 사용하고 1초 미만 단위로 캐시 조정이 불가능하다.
- A → B → A 와 같은 데이터 변경이 일어났을 경우, 결론적인 데이터는 같지만, 수정일이 다르기 때문에 다시 다운로드 받아야 한다.
- 서버에서 별도의 캐시 로직을 관리하고 싶을 경우
    - e.g. 스페이스나 주석처럼 크게 영향이 없는 변경에서 캐시를 유지하고 싶은 경우

### ETag 와 If-None-Match

> **ETag: "aaaaaaaaaa"**
> 
- 캐시용 데이터에 임의의 고유 버전 이름을 달아둔다.
- 데이터가 변경되면 이 이름을 바꾸어서 변경한다. (Hash 를 다시 생성)

## 캐시와 조건부 요청 헤더

---

### Cache-Control: 캐시 제어

캐시 지시어 (directives)

- Cache-Control: max-age
    - 캐시 유효 시간, 초 단위
- Cache-Control: no-cache
    - 데이터는 캐시해도 되지만, 항상 origin 서버에 검증하고 사용
- Cache-Control: no-store
    - 데이터에 민감한 정보가 있으므로 저장하면 안됨 (메모리에서 사용하고 최대한 빨리 삭제)

## 프록시 캐시

---

### 프록시 캐시 서버란?

프록시는 클라이언트와 서버 사이 대리 통신을 수행하는 것을 의미한다.

프록시 캐시 서버란 원 서버에서 다운로드 받을 캐시를 미리 받아놓는 일종의 중계 캐시 서버를 의미한다.

기타 캐시 지시어

- Cache-Control: public
    - 응답이 public 캐시에 저장되어도 됨
- Cache-Control: private
    - 응답이 해당 사용자만을 위한 것이므로 private 캐시에 저장해야 함
- Cache-Control: s-maxage
    - 프록시 캐시에만 적용되는 max-age
- Age: 60 (HTTP 헤더)
    - origin 서버에서 응답 후 프록시 캐시 내에 머문 시간 (초)

## 캐시 무효화

---

브라우저가 캐시하면 안되는 정보들에 대하여 확실하게 캐시를 무효화하고 싶을 때 사용해야 하는 지시어들이다.

- Cache-Control: no-cache
    - 데이터는 캐시해도 되지만, 항상 원 서버에 검증하고 사용
- Cache-Control: no-store
    - 데이터에 민감한 정보가 있으므로 저장하면 안됨 (메모리에서 사용하고 최대한 빨리 삭제)
- Cache-Control: must-revalidate
    - 캐시 만료 후 최초 조회 시 원 서버에 검증해야 함
    - 원 서버 접근 실패 시 반드시 오류가 발생해야 함 - 504 Gateway Timeout
    - must-revalidate 는 캐시 유효 시간이라면 캐시를 사용함
- Pragma: no-cache
    - HTTP 1.0 하위 호환

### no-cache vs must-revalidate

프록시 캐시와 원 서버가 순간 단절되어 원 서버 접근이 불가한 경우

- no-cache 는 프록시 서버의 데이터라도 조회하여 응답하는 경우가 있음
- must-revalidate 는 항상 504 에러를 응답해야 함